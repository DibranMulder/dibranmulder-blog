<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30986898-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30986898-2');
</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-1187111537862676",
          enable_page_level_ads: true
     });
</script>
  
  <title>Dibran&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="Azure, Development, Cloud, DevOps.">
<meta property="og:type" content="website">
<meta property="og:title" content="Dibran&#39;s Blog">
<meta property="og:url" content="http://dibranmulder.github.io/index.html">
<meta property="og:site_name" content="Dibran&#39;s Blog">
<meta property="og:locale" content="NL">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dibran&#39;s Blog">
  
    <link rel="alternate" href="/atom.xml" title="Dibran&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dibran&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Cloud, Modern web technologies, Microsoft, security and more</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://dibranmulder.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Learn-CosmosDb-in-20-pictures" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/18/Learn-CosmosDb-in-20-pictures/" class="article-date">
  <time datetime="2019-06-18T12:33:56.000Z" itemprop="datePublished">2019-06-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/18/Learn-CosmosDb-in-20-pictures/">Learn CosmosDb in 20 pictures</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The Azure CosmosDb team published a series of cartoons on their <a href="https://twitter.com/AzureCosmosDB" target="_blank" rel="noopener">twitter account</a> to explain alot of CosmosDb features. I collected them and thought it would be nice to reshare them with you. Happy learning!</p>
<p><img src="/images/cosmos/resource model.png"></p>
<p><hr><br><img src="/images/cosmos/regional presence.png"></p>
<p><hr><br><img src="/images/cosmos/database design.png"></p>
<p><hr><br><img src="/images/cosmos/database modeling.png"></p>
<p><hr><br><img src="/images/cosmos/data modeling ref vs embed.png"></p>
<p><hr><br><img src="/images/cosmos/partioning.png"></p>
<p><hr><br><img src="/images/cosmos/partioning key.png"></p>
<p><hr><br><img src="/images/cosmos/provisioning througput.png"></p>
<p><hr><br><img src="/images/cosmos/request units.png"></p>
<p><hr><br><img src="/images/cosmos/requests units 2.png"></p>
<p><hr><br><img src="/images/cosmos/indexing 2.png"></p>
<p><hr><br><img src="/images/cosmos/indexing.png"></p>
<p><hr><br><img src="/images/cosmos/quering with indexes.png"></p>
<p><hr><br><img src="/images/cosmos/global distribution.png"></p>
<p><hr><br><img src="/images/cosmos/change feed v2.png"></p>
<p><hr><br><img src="/images/cosmos/cosmosdb change feed.png"></p>
<p><hr><br><img src="/images/cosmos/consistency levels.png"></p>
<p><hr><br><img src="/images/cosmos/consistency models.png"></p>
<p><hr><br><img src="/images/cosmos/durability and recovery time.png"></p>
<p><hr><br><img src="/images/cosmos/lambda architecture.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2019/06/18/Learn-CosmosDb-in-20-pictures/" data-id="cjx1slxpz000860cchepo6rc7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CosmosDb/">CosmosDb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Testing-time-triggered-Azure-Functions" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/20/Testing-time-triggered-Azure-Functions/" class="article-date">
  <time datetime="2019-05-20T11:24:46.000Z" itemprop="datePublished">2019-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/20/Testing-time-triggered-Azure-Functions/">Locally testing Azure Functions</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Azure Functions with for instance TimeTriggers or ServiceBusTriggers can be difficult to test. Especially when you’re trying not to interfere in a development or testing environment. What a lot of people don’t know is that the Azure Functions platform provides a feature to manually trigger Azure Functions, regardless of their actual trigger type.</p>
<p>The only thing you’ll have to do is to send a Http POST message to an admin enpoint. <strong>Keep it mind to add a payload with at least an empty input property</strong>, otherwise the function will not be triggered.</p>
<p>Take for instance this Functions with a TimeTrigger named <code>TriggerOnTime</code>.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Functions</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">FunctionName(<span class="meta-string">"TriggerOnTime"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DoSomethingAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        [TimerTrigger(<span class="string">"0 0 */8 * * *"</span></span>)] TimerInfo myTimer,</span></span><br><span class="line"><span class="function">        ILogger log)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        log.LogInformation(<span class="string">"This function triggers every 8 hours."</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>To manually fire this off, perform a Http POST message to the following endpoint: <code>POST: http://localhost:7071/admin/functions/TriggerOnTime</code><br>Don’t forget to add an empty payload.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"input"</span>: <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>You can perform this request with a simple curl command.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl</span><br><span class="line">    --header <span class="string">"Content-Type: application/json"</span></span><br><span class="line">    --request POST </span><br><span class="line">    --data <span class="string">'&#123;"input":""&#125;'</span> </span><br><span class="line">    http://localhost:7071/admin/<span class="built_in">functions</span>/TriggerOnTime</span><br></pre></td></tr></table></figure></p>
<p>To mock a ServiceBusMessage simple provide the JSON serialized content of the message inside the input property.</p>
<p>Happy coding!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2019/05/20/Testing-time-triggered-Azure-Functions/" data-id="cjx1slxq4000g60ccru1r986v" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-Functions/">Azure Functions</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Versioning-with-Azure-PaaS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/16/Versioning-with-Azure-PaaS/" class="article-date">
  <time datetime="2019-04-16T12:45:39.000Z" itemprop="datePublished">2019-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/16/Versioning-with-Azure-PaaS/">Versioning with Azure PaaS and Serverless</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Working with multiple teams on a big microservices architecture can be a real struggle. What I often see is that teams are responsible for their set of microservices and struggle to isolate their services. Resulting in the following problems:</p>
<ul>
<li>Teams are not able to release independently.</li>
<li>Teams are building release trains that have to be coordinated precisely.<ul>
<li>Hence, companies are hiring people as release coordinators.</li>
</ul>
</li>
<li>Reverting release trains is not possible, fix-over-fix scenario’s will occur.</li>
<li>The applications are temporary in a state of flux while releasing a train.</li>
</ul>
<p><img src="/images/versioning/releasetrain.png"></p>
<p>What we ideally want is that teams stop building release trains and start releasing independently at any given time of the day. However, a lot has to be done before companies achieve that kind of development maturity. I came up with a set of principles that will guide an organization to become more maturity, and there by increasing flexibility, productivity and quality.</p>
<h3 id="The-golden-principles"><a href="#The-golden-principles" class="headerlink" title="The golden principles."></a>The golden principles.</h3><ol>
<li>Services must be able to run independently.<ul>
<li>Services must be able to reconnect with other services. Any dependency can be deployed at any time. Design your service to fail.</li>
</ul>
</li>
<li>Services can never introduce breaking changes.<ul>
<li>This means services should adopt a versioning strategy.</li>
</ul>
</li>
<li>There can be no direct dependencies between services, that means no direct REST interfaces anymore.</li>
<li>Teams are able to release their service at any given time.</li>
<li>Teams are responsible and accountable for their own services.</li>
</ol>
<p>Most of the principles are kind of straight forward, but keep in mind they are key for success. Sometimes simple principles are the hardest to implement, especially when you have legacy components in your microservices architecture, or maybe because it’s technically difficult to implement them. In this blog I’ll help you implementing some of the principles in Azure PaaS and Serverless services. Let’s start with a combination of versioning strategy and mitigating direct dependencies. </p>
<h2 id="Service-bus-versioning"><a href="#Service-bus-versioning" class="headerlink" title="Service bus versioning"></a>Service bus versioning</h2><p>The most common way for microservices to communicate in an asynchronous matter on Azure is the use of Azure Service Bus. With Azure Service Bus, teams can define message channels to communicate between microservices. What a lot of development teams forget is to adopt a versioning strategy for their service bus messages.</p>
<p>One way of versioning service bus messages is to add a <code>custom property</code> to a message. I like this better then to add a <code>version</code> property to the actual JSON or XML message because, in my opinion, a version is not part of the data you actually want to send, it’s the metadata. It’s important for the consuming party to know.</p>
<p>So depending on the programming language you use you can add a <code>custom message property</code> to a service bus message. In C# it will look like something like this.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Data you want to send.</span></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span></span><br><span class="line">&#123;</span><br><span class="line">    name = <span class="string">"Dibran"</span>,</span><br><span class="line">    lastName = <span class="string">"Mulder"</span>,</span><br><span class="line">    position = <span class="string">"Dev"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Serialize to JSON.</span></span><br><span class="line"><span class="keyword">string</span> json = JsonConvert.SerializeObject(user);</span><br><span class="line">Message message = <span class="keyword">new</span> Message(Encoding.UTF8.GetBytes(json));</span><br><span class="line"><span class="comment">// Add a custom verison property.</span></span><br><span class="line">message.UserProperties.Add(<span class="string">"Version"</span>, <span class="string">"1.0"</span>);</span><br></pre></td></tr></table></figure></p>
<p>I like to keep the version the same as the version of your microservice. In this way we are not bogged down into a versioning hell. The version of the message is equal to the version of the service that actually created the message. A simple but effective rule. In this way you can also track by what version of a microservice a message is actually created.</p>
<p>With <a href="https://github.com/paolosalvatori/ServiceBusExplorer" target="_blank" rel="noopener">Azure Service Bus explorer</a> you can easily check messages, create additional subscriptions, etc. I highly recommend you to use it, you can see what kind of messages are send and also inspect the custom message properties. It’s a nice tool to debug your versioning strategy.</p>
<p>So if you send messages with a Version <code>custom message property</code> you can create for instance create 2 subscriptions for each version. With a service bus filter you can then make sure that messages with a specific version are only received by certain topics.</p>
<p><img src="/images/versioning/servicebus.png"><br><img src="/images/versioning/sendmessage.png"></p>
<p>A simple service bus filter can be:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Version='1.0'</span><br></pre></td></tr></table></figure></p>
<p><strong>Don’t forget to remove the default rule: 1=1.</strong> If one of the rules match a message will be accepted by a subscription.</p>
<p>You can also choose to do the filtering and version handling in the consuming service. But I personally like it better to separate messages in subscriptions based on version numbers.</p>
<p>Lastly, I would like to add that service bus filters can easily be created by <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-resource-manager-namespace-topic-with-rule" target="_blank" rel="noopener">ARM scripts</a>. In this way you won’t need to service bus explorer or code to manage your infrastructure. </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"[variables('sbVersion')]"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"[parameters('serviceBusRuleName')]"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Rules"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[parameters('serviceBusSubscriptionName')]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"filterType"</span>: <span class="string">"SqlFilter"</span>,</span><br><span class="line">        <span class="attr">"sqlFilter"</span>: &#123;</span><br><span class="line">            <span class="attr">"sqlExpression"</span>: <span class="string">"Version = '1.0'"</span>,</span><br><span class="line">            <span class="attr">"requiresPreprocessing"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"action"</span>: &#123;</span><br><span class="line">            <span class="attr">"sqlExpression"</span>: <span class="string">"set FilterTag = 'true'"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Azure-Functions-versioning"><a href="#Azure-Functions-versioning" class="headerlink" title="Azure Functions versioning"></a>Azure Functions versioning</h2><p>With Azure functions it’s pretty easy to handle versioning. You can add a versioning scheme to the route of an <code>Http Trigger</code> like this.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"SomeHttpFunction"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(</span></span></span><br><span class="line"><span class="function"><span class="params">        AuthorizationLevel.Function,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">"POST"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        Route = <span class="string">"api/v1/entity"</span></span>)]</span></span><br><span class="line"><span class="function">    HttpRequestMessage req,</span></span><br><span class="line"><span class="function">    ILogger log)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>However, routing in Azure Functions is pretty badly implemented. ASP.net core handles it way better and its therefore highly recommended to use an API gateway in front of it. As I described in <a href="https://dibranmulder.github.io/2018/10/19/Building-Serverless-APIs-in-Azure/">this blog post</a> you can use for instance Azure API Management to handle that for you. You will then get a lot of additional options such as: routing, mocking, caching, authorization, etc.<br><img src="/images/serverless/Serverless.png"></p>
<h2 id="ASP-net-core-versioning"><a href="#ASP-net-core-versioning" class="headerlink" title="ASP.net core versioning"></a>ASP.net core versioning</h2><p>Lastly I would like to point out to a very nice <a href="https://github.com/Microsoft/aspnet-api-versioning" target="_blank" rel="noopener">Github repository</a> for ASP.net core versioning. It has several examples to implement versioning correctly. Versioning is actually a 1st class citizen in ASP.net core, enabling you to adopt a solid strategy and never make breaking changes again.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2019/04/16/Versioning-with-Azure-PaaS/" data-id="cjx1slxq5000i60cc18luz0gy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/">Azure, PaaS, Serverless, Teams, Agile, Versioning</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/22/Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps/" class="article-date">
  <time datetime="2019-03-22T08:36:42.000Z" itemprop="datePublished">2019-03-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/22/Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps/">Migrating Azure Table Storage to SQL with Azure Logic Apps</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’ve created an App that uses Azure Table Storage as a backing store. At first this looked like the right decision but after a while I figured that I should migrate to a relational database. But in the mean while the Table Storage database grew quite big. I’m not talking about millions of records but more like: 5 tables with about 100k of records in it. So how do you migrate that data to a SQL Server database? I figured I would use Azure Logic Apps.</p>
<p><img src="/images/logicapps/start-logic-app.png"></p>
<p>It all starts with a trigger, in Azure Logic Apps a manual trigger is often an Http Request. After that I initialize 2 variables, the <code>FirstRun</code> and <code>NextRowKey</code> variables. The <code>FirstRun</code> is used to call the Azure Table Storage tables without a <code>NextRowKey</code> query parameter. Once the first page is fetched this variable will be set to <code>false</code> and the subsequent pages will be requested with a <code>NextRowKey</code> query parameter. This is the first step to fetch your data with pages. <strong>Bear in mind Azure Table Storage can only return 1000 records per request!</strong> </p>
<p>The JSON for initializing the variables.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Init_first_run"</span>: &#123;</span><br><span class="line">        <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">            <span class="attr">"variables"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"name"</span>: <span class="string">"FirstRun"</span>,</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"Boolean"</span>,</span><br><span class="line">                    <span class="attr">"value"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"runAfter"</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"InitializeVariable"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"Initialize_nextrowkey"</span>: &#123;</span><br><span class="line">        <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">            <span class="attr">"variables"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"name"</span>: <span class="string">"NextRowKey"</span>,</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"String"</span>,</span><br><span class="line">                    <span class="attr">"value"</span>: <span class="string">""</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">            <span class="attr">"Init_first_run"</span>: [</span><br><span class="line">                <span class="string">"Succeeded"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"InitializeVariable"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/logicapps/until.png"><br>The next part is to repeat the fetch records part until there are no more records or when its the first run. I use this expression to check wether to continue or not: <code>@and(equals(variables(&#39;NextRowKey&#39;), null), not(variables(&#39;FirstRun&#39;)))</code></p>
<p>After that I use a condition Action to check whether its the first run or not. Remember I initialize a variable to determine if its the first run.  If its the first run that obviously we’ve to set the <code>FirstRun</code> variable to <code>false</code>. After that its just quite simple, either we fetch a page with a <code>NextRowKey</code> query parameter or not. Either way we Parse the outcome of the fetch entities and loop over it to insert the records into the SQL database.</p>
<p>The trick is to retrieve the <code>NextRowKey</code> token from the Http Response header of the <code>Get Entities</code> action. I’ve searched in the documentation but its actually quite hard to come up with an expression to get it. But here it is: <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Set_variable"</span>: &#123;</span><br><span class="line">        <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"NextRowKey"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"@&#123;actions('Get_next_page')?['outputs']?['headers']?['x-ms-continuation-NextRowKey']&#125;"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">            <span class="attr">"Get_next_page"</span>: [</span><br><span class="line">                <span class="string">"Succeeded"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"SetVariable"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>So basically, we refer to the <code>action</code> to fetch the next page, check at its <code>ouputs</code>, look at its <code>headers</code> and get the <code>x-ms-continuation-NextRowKey</code>. We then set the value of it in the <code>NextRowKey</code> iteration and use it to fetch the next page. Its actually quite easy but sometimes it can be hard to get the right syntax. I find this <a href="&#39;https://docs.microsoft.com/en-us/azure/logic-apps/workflow-definition-language-functions-reference&#39;">Workflow definition functions reference documentation</a> very handy.</p>
<h2 id="Complete-Workflow-definition"><a href="#Complete-Workflow-definition" class="headerlink" title="Complete Workflow definition"></a>Complete Workflow definition</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"$connections"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: &#123;</span><br><span class="line">            <span class="attr">"azuretables"</span>: &#123;</span><br><span class="line">                <span class="attr">"connectionId"</span>: <span class="string">"/subscriptions/9b4ed9c7-de20-49df-b301-d39322443140/resourceGroups/TradersmateBackend/providers/Microsoft.Web/connections/azuretables"</span>,</span><br><span class="line">                <span class="attr">"connectionName"</span>: <span class="string">"azuretables"</span>,</span><br><span class="line">                <span class="attr">"id"</span>: <span class="string">"/subscriptions/9b4ed9c7-de20-49df-b301-d39322443140/providers/Microsoft.Web/locations/westeurope/managedApis/azuretables"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"sql"</span>: &#123;</span><br><span class="line">                <span class="attr">"connectionId"</span>: <span class="string">"/subscriptions/9b4ed9c7-de20-49df-b301-d39322443140/resourceGroups/TradersmateBackend/providers/Microsoft.Web/connections/sql"</span>,</span><br><span class="line">                <span class="attr">"connectionName"</span>: <span class="string">"sql"</span>,</span><br><span class="line">                <span class="attr">"id"</span>: <span class="string">"/subscriptions/9b4ed9c7-de20-49df-b301-d39322443140/providers/Microsoft.Web/locations/westeurope/managedApis/sql"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"definition"</span>: &#123;</span><br><span class="line">        <span class="attr">"$schema"</span>: <span class="string">"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#"</span>,</span><br><span class="line">        <span class="attr">"actions"</span>: &#123;</span><br><span class="line">            <span class="attr">"Init_first_run"</span>: &#123;</span><br><span class="line">                <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                    <span class="attr">"variables"</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"name"</span>: <span class="string">"FirstRun"</span>,</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="string">"Boolean"</span>,</span><br><span class="line">                            <span class="attr">"value"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"runAfter"</span>: &#123;&#125;,</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"InitializeVariable"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Initialize_nextrowkey"</span>: &#123;</span><br><span class="line">                <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                    <span class="attr">"variables"</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">"name"</span>: <span class="string">"NextRowKey"</span>,</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="string">"String"</span>,</span><br><span class="line">                            <span class="attr">"value"</span>: <span class="string">""</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">                    <span class="attr">"Init_first_run"</span>: [</span><br><span class="line">                        <span class="string">"Succeeded"</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"InitializeVariable"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Until"</span>: &#123;</span><br><span class="line">                <span class="attr">"actions"</span>: &#123;</span><br><span class="line">                    <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                        <span class="attr">"actions"</span>: &#123;</span><br><span class="line">                            <span class="attr">"Get_first_page"</span>: &#123;</span><br><span class="line">                                <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"host"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"connection"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"name"</span>: <span class="string">"@parameters('$connections')['azuretables']['connectionId']"</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"method"</span>: <span class="string">"get"</span>,</span><br><span class="line">                                    <span class="attr">"path"</span>: <span class="string">"/Tables/@&#123;encodeURIComponent('yourTable')&#125;/entities"</span>,</span><br><span class="line">                                    <span class="attr">"queries"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"$select"</span>: <span class="string">"PropA, PropB"</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"Set_variable_3"</span>: [</span><br><span class="line">                                        <span class="string">"Succeeded"</span></span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"ApiConnection"</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"Set_variable_2"</span>: &#123;</span><br><span class="line">                                <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"name"</span>: <span class="string">"NextRowKey"</span>,</span><br><span class="line">                                    <span class="attr">"value"</span>: <span class="string">"@&#123;actions('Get_first_page')?['outputs']?['headers']?['x-ms-continuation-NextRowKey']&#125;"</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"Get_first_page"</span>: [</span><br><span class="line">                                        <span class="string">"Succeeded"</span></span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"SetVariable"</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"Set_variable_3"</span>: &#123;</span><br><span class="line">                                <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"name"</span>: <span class="string">"FirstRun"</span>,</span><br><span class="line">                                    <span class="attr">"value"</span>: <span class="literal">false</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"runAfter"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"SetVariable"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"else"</span>: &#123;</span><br><span class="line">                            <span class="attr">"actions"</span>: &#123;</span><br><span class="line">                                <span class="attr">"Get_next_page"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"host"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"connection"</span>: &#123;</span><br><span class="line">                                                <span class="attr">"name"</span>: <span class="string">"@parameters('$connections')['azuretables']['connectionId']"</span></span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"method"</span>: <span class="string">"get"</span>,</span><br><span class="line">                                        <span class="attr">"path"</span>: <span class="string">"/Tables/@&#123;encodeURIComponent('userTrackedProducts')&#125;/entities"</span>,</span><br><span class="line">                                        <span class="attr">"queries"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"$select"</span>: <span class="string">"PropA, PropB"</span>,</span><br><span class="line">                                            <span class="attr">"NextRowKey"</span>: <span class="string">"@variables('NextRowKey')"</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"runAfter"</span>: &#123;&#125;,</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="string">"ApiConnection"</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"Set_variable"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"name"</span>: <span class="string">"NextRowKey"</span>,</span><br><span class="line">                                        <span class="attr">"value"</span>: <span class="string">"@&#123;actions('Get_next_page')?['outputs']?['headers']?['x-ms-continuation-NextRowKey']&#125;"</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"Get_next_page"</span>: [</span><br><span class="line">                                            <span class="string">"Succeeded"</span></span><br><span class="line">                                        ]</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="string">"SetVariable"</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"expression"</span>: &#123;</span><br><span class="line">                            <span class="attr">"and"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">"equals"</span>: [</span><br><span class="line">                                        <span class="string">"@variables('FirstRun')"</span>,</span><br><span class="line">                                        <span class="literal">true</span></span><br><span class="line">                                    ]</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"runAfter"</span>: &#123;&#125;,</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"If"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"For_each"</span>: &#123;</span><br><span class="line">                        <span class="attr">"actions"</span>: &#123;</span><br><span class="line">                            <span class="attr">"Insert_products"</span>: &#123;</span><br><span class="line">                                <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"body"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"PropA"</span>: <span class="string">"@items('For_each')['PropA']"</span>,</span><br><span class="line">                                        <span class="attr">"PropB"</span>: <span class="string">"@items('For_each')?['PropB']"</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"host"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"connection"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"name"</span>: <span class="string">"@parameters('$connections')['sql']['connectionId']"</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"method"</span>: <span class="string">"post"</span>,</span><br><span class="line">                                    <span class="attr">"path"</span>: <span class="string">"/datasets/default/tables/@&#123;encodeURIComponent(encodeURIComponent('[dbo].[YourTable]'))&#125;/items"</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"runAfter"</span>: &#123;&#125;,</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"ApiConnection"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"foreach"</span>: <span class="string">"@body('Parse_JSON_2')"</span>,</span><br><span class="line">                        <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">                            <span class="attr">"Parse_JSON_2"</span>: [</span><br><span class="line">                                <span class="string">"Succeeded"</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"Foreach"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"Parse_JSON_2"</span>: &#123;</span><br><span class="line">                        <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                            <span class="attr">"content"</span>: <span class="string">"@if(not(variables('FirstRun')), body('Get_next_page')?['value'], body('Get_first_page')?['value'])"</span>,</span><br><span class="line">                            <span class="attr">"schema"</span>: &#123;</span><br><span class="line">                                <span class="attr">"items"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"PropA"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"type"</span>: <span class="string">"string"</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"PropB"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"type"</span>: <span class="string">"string"</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">"required"</span>: [</span><br><span class="line">                                        <span class="string">"odata.etag"</span>,</span><br><span class="line">                                        <span class="string">"PropA"</span>,</span><br><span class="line">                                        <span class="string">"PropB"</span></span><br><span class="line">                                    ],</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="string">"object"</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"array"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">                            <span class="attr">"Condition"</span>: [</span><br><span class="line">                                <span class="string">"Succeeded"</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"ParseJson"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"expression"</span>: <span class="string">"@and(equals(variables('NextRowKey'), null), not(variables('FirstRun')))"</span>,</span><br><span class="line">                <span class="attr">"limit"</span>: &#123;</span><br><span class="line">                    <span class="attr">"count"</span>: <span class="number">60</span>,</span><br><span class="line">                    <span class="attr">"timeout"</span>: <span class="string">"PT1H"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"runAfter"</span>: &#123;</span><br><span class="line">                    <span class="attr">"Initialize_nextrowkey"</span>: [</span><br><span class="line">                        <span class="string">"Succeeded"</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"Until"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"contentVersion"</span>: <span class="string">"1.0.0.0"</span>,</span><br><span class="line">        <span class="attr">"outputs"</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">"parameters"</span>: &#123;</span><br><span class="line">            <span class="attr">"$connections"</span>: &#123;</span><br><span class="line">                <span class="attr">"defaultValue"</span>: &#123;&#125;,</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"Object"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"triggers"</span>: &#123;</span><br><span class="line">            <span class="attr">"manual"</span>: &#123;</span><br><span class="line">                <span class="attr">"inputs"</span>: &#123;</span><br><span class="line">                    <span class="attr">"schema"</span>: &#123;&#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"kind"</span>: <span class="string">"Http"</span>,</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"Request"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2019/03/22/Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps/" data-id="cjx1slxqz001x60cc0xsmveg3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logic-Apps/">Logic Apps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-Server/">SQL Server</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Table-Storage/">Table Storage</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Building-a-Web-Scraper-in-Azure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/15/Building-a-Web-Scraper-in-Azure/" class="article-date">
  <time datetime="2019-02-15T14:44:40.000Z" itemprop="datePublished">2019-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/15/Building-a-Web-Scraper-in-Azure/">Building a Web Scraper in Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Building a web scraper is pretty hard. Doing it in Azure is harder. Utilizing Serverless and PaaS services is challenging. I don’t want to pay for a VM and just deploy the scraper on it because I need the solution to be scalable. Secondly I only want to pay for actual usage and not for a VM thats idle.</p>
<h2 id="The-case"><a href="#The-case" class="headerlink" title="The case"></a>The case</h2><p>I want to scrape certain websites twice a day. At 10:00 UTC and at 18:00 UTC. This frequency might change in the future so I don’t want to have it build in hard coded. I’m scraping ecommerce sites and the pages that need to be scraped depend on a list of id’s comming from a database. So the input for the scraper is dynamic. Lastly the output of the scraper has to be stored in a database. Later on I will have to develop some UI which discloses the information for ecommerce traders.</p>
<h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><p><img src="/images/scraper/azure-web-scraper.png"><br>Web scraping comes in different shapes and sizes. Some packages just perform Http calls and evaluate the response. Others spin up and entire (headless) browser and perform actual DOM operations. Since I want to scrape different ecommerce sites spinning up an actual browser looked like the way to go. Also because lots of ecommerce sites rely on alot on JavaScript. Some are build as an SPA and that requires per definition a browser based approach. After some research I stumbled upon <code>puppeteer</code>. A headless Chrome API build by Google itself, very promising.</p>
<p>My initial idea was to run puppeteer inside an Azure Function, however after some research I came to the conclusion that running a headless browser on Azure PaaS or Serverless <a href="https://github.com/GoogleChrome/puppeteer/issues/515" target="_blank" rel="noopener">is not going to happen</a>. So what are the alternatives? Well containers seems like a reasonable solution. I can spin up and tear down the container with some orchestration and thereby limit my costs. A good start point for running puppeteer containers in Azure is <a href="https://medium.com/@bogdanbujdea/running-puppeteer-in-azure-container-instances-b24fb0a8d3e" target="_blank" rel="noopener">this blog post</a>.</p>
<p>For orchestrating the scraper I was thinking about using Azure Functions again. But then on a bright day I figured I would use Azure Logic Apps instead. Logic Apps are great for defining and running workflows and look like a perfect fit. They are pay per usage and are easy to develop!</p>
<h3 id="Puppeteer-TypeScript-and-NodeJs"><a href="#Puppeteer-TypeScript-and-NodeJs" class="headerlink" title="Puppeteer, TypeScript and NodeJs"></a>Puppeteer, TypeScript and NodeJs</h3><p>I wanted to brush up my TypeScript and NodeJS skills since it has been a while that I seriously developed in TypeScript. The last time I did something significant I was still using Visual Studio instead of VS Code for TypeScript development. So here’s the story to get a puppeteer scraper working in NodeJs and TypeScript.</p>
<h4 id="Depedencies"><a href="#Depedencies" class="headerlink" title="Depedencies"></a>Depedencies</h4><p>First of all get TypeScript tsconfig.json file there using the following command.<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tsc --init</span><br><span class="line">message TS6071: Successfully created a tsconfig.json file.</span><br></pre></td></tr></table></figure></p>
<p>A sample of how your TypeScript configuration file might look like is this.<br>Once important thing is to enable source maps. This allows you to debug your TypeScript code instead of debugging the transpiled JavaScript (which is a mess).<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">      <span class="attr">"target"</span>: <span class="string">"es5"</span>,</span><br><span class="line">      <span class="attr">"declaration"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"lib"</span>: [</span><br><span class="line">          <span class="string">"es2015"</span>, <span class="string">"dom"</span></span><br><span class="line">      ]        </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"exclude"</span>: [</span><br><span class="line">      <span class="string">"node_modules"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Once you’ve setup the TypeScript configuration its time to setup a NPM project.<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br></pre></td></tr></table></figure></p>
<p>You are now ready to start developing your TypeScript application.<br>You probably need some packages to interface with Puppeteer, Azure storage or whatever. Install them using npm.<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install puppeteer --save</span><br><span class="line">npm install azure-storage --save</span><br><span class="line">npm install azure-sb --save</span><br></pre></td></tr></table></figure></p>
<p>A lot of packages got separate TypeScript definition packages. These are required to have type checking. We also require them for puppeteer. You should install them as a dev-dependency instead of a regular dependency.<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install @types/puppeteer --save-dev</span><br><span class="line">npm install @types/azure-sb --save-dev</span><br></pre></td></tr></table></figure></p>
<h4 id="Puppeteer"><a href="#Puppeteer" class="headerlink" title="Puppeteer"></a>Puppeteer</h4><p>Once you’ve installed your dependencies you can start developing your scraper. It’s all up to you to interact with the page and retrieve the right information. A very basic example is this:<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> puppeteer <span class="keyword">from</span> <span class="string">'puppeteer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"><span class="keyword">await</span> page.goto(<span class="string">'https://somesite.com'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Evaluate the page and interact with it.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> browser.close();</span><br></pre></td></tr></table></figure></p>
<p>One thing you probably want to do is to debug your code. In VSCode you’ll have to add a debug configuration. This can be achieved by adding the following configuration in <code>launch.json</code>. Notice the “Launch program” configuration inside the debug panel of VS Code.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="attr">"preLaunchTask"</span>: <span class="string">"tsc"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Launch Program "</span>,</span><br><span class="line">            <span class="attr">"sourceMaps"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"program"</span>: <span class="string">"$&#123;workspaceFolder&#125;\\src\\index.js"</span>,</span><br><span class="line">            <span class="attr">"outFiles"</span>: [</span><br><span class="line">                <span class="string">"$&#123;workspaceFolder&#125;/**/*.js"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Docker-and-Azure"><a href="#Docker-and-Azure" class="headerlink" title="Docker and Azure"></a>Docker and Azure</h3><p>Well you’ve got your scraper working on Node using TypeScript. The next thing is to host it in the Cloud. We want to containerize the application inside a docker container. Building a docker container requires a dockerfile. Here’s one that works for the Puppeteer scraper. The Google Chrome teams has made a nice <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md#running-puppeteer-in-docker" target="_blank" rel="noopener">Docker file</a> with some tricks applied, I basically copied that. Secondly <a href="https://medium.com/@bogdanbujdea/running-puppeteer-in-azure-container-instances-b24fb0a8d3e" target="_blank" rel="noopener">is this</a> a nice blogpost about running Docker containers on Azure Container Instances. Its worth a read.</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">8</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get -yq upgrade &amp;&amp; apt-get install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get autoremove &amp;&amp; apt-get autoclean</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN apt-get update &amp;&amp; apt-get install -y wget --no-install-recommends \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sh -c <span class="string">'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" &gt;&gt; /etc/apt/sources.list.d/google.list'</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y google-chrome-unstable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst ttf-freefont \</span></span><br><span class="line"><span class="bash">      --no-install-recommends \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get purge --auto-remove -y curl \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /src/*.deb</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ADD https://github.com/Yelp/dumb-init/releases/download/v1.2.1/dumb-init_1.2.1_amd64 /usr/<span class="built_in">local</span>/bin/dumb-init</span></span><br><span class="line"><span class="bash">RUN chmod +x /usr/<span class="built_in">local</span>/bin/dumb-init</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># copy project files and install dependencies</span></span></span><br><span class="line"><span class="bash">COPY . /var/app  </span></span><br><span class="line"><span class="bash">WORKDIR /var/app</span></span><br><span class="line"><span class="bash">RUN npm install</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN npm i puppeteer </span></span><br><span class="line"><span class="bash">ENV AZURE_STORAGE_CONNECTION_STRING=secret</span></span><br><span class="line"><span class="bash">ENV AZURE_SERVICEBUS_CONNECTION_STRING=secret</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Add pptr user.</span></span></span><br><span class="line"><span class="bash">RUN groupadd -r pptruser &amp;&amp; useradd -r -g pptruser -G audio,video pptruser \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /home/pptruser/Downloads \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chown -R pptruser:pptruser /home/pptruser \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chown -R pptruser:pptruser /var/app</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Run user as non privileged.</span></span></span><br><span class="line"><span class="bash">USER pptruser</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"dumb-init"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash">CMD [ <span class="string">"node"</span>, <span class="string">"src/index.js"</span> ]</span></span><br></pre></td></tr></table></figure>
<h3 id="Service-bus"><a href="#Service-bus" class="headerlink" title="Service bus"></a>Service bus</h3><p>Now that we’ve got a very basis scraper running inside a Docker container on Azure Container Instances, its time to feed to scraper with commands.<br>I therefore created a queue of <code>scrape commands</code>. I prefer using Service Bus technology over Http REST interfaces because it has better fault handling. Secondly it might take a while for a scrape commands to finish and I dont want to run in any Http timeouts or whatsoever.</p>
<p>So we have to listen to a Service Bus inside your Node application. Microsoft has created a package that can be used to setup a connection, namely: <code>azure-sb</code>.<br>Here’s the code to listen to Service Bus messages on a queue.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> azure <span class="keyword">from</span> <span class="string">"azure-sb"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Logger &#125; <span class="keyword">from</span> <span class="string">"./logger"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> logger = <span class="keyword">new</span> Logger(instrumentationKey);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForMessages</span>(<span class="params">sbService: azure.ServiceBusService, queueName: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options: azure.Azure.ServiceBus.ReceiveSubscriptionMessageOptions = &#123;</span><br><span class="line">    timeoutIntervalInS: <span class="number">60</span>,</span><br><span class="line">    isPeekLock: <span class="literal">true</span></span><br><span class="line">  &#125;;</span><br><span class="line">  sbService.receiveQueueMessage(queueName, options, <span class="function"><span class="keyword">function</span> (<span class="params">err: <span class="built_in">Error</span> | <span class="literal">null</span> | <span class="built_in">string</span>, lockedMessage: azure.Azure.ServiceBus.Message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err == <span class="string">'No messages to receive'</span>) &#123;</span><br><span class="line">        logger.log(<span class="string">'No messages'</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        processMessage(sbService, err, <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      processMessage(sbService, <span class="literal">null</span>, lockedMessage);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processMessage</span>(<span class="params">sbService: azure.ServiceBusService, err: <span class="built_in">Error</span> | <span class="literal">null</span> | <span class="built_in">string</span>, lockedMsg: azure.Azure.ServiceBus.Message</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    logger.log(<span class="string">'Error processing message: '</span> + err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logger.log(<span class="string">'Processing message - setting lock'</span>);</span><br><span class="line">    <span class="keyword">const</span> model = <span class="built_in">JSON</span>.parse(lockedMsg.body) <span class="keyword">as</span> Model;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initiate your scrape here.</span></span><br><span class="line"></span><br><span class="line">    sbService.deleteMessage(lockedMsg, <span class="function"><span class="keyword">function</span> (<span class="params">err2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err2) &#123;</span><br><span class="line">        logger.log(<span class="string">'Failed to delete message: '</span> + err2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.log(<span class="string">'Deleted message.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> queueName = <span class="string">'queuename'</span>;</span><br><span class="line">logger.log(<span class="string">'Connecting to queue '</span> + queueName);</span><br><span class="line"><span class="keyword">var</span> sbService = azure.createServiceBusService(AZURE_SERVICEBUS_CONNECTION_STRING);</span><br><span class="line">sbService.createQueueIfNotExists(queueName, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    logger.log(<span class="string">'Failed to create queue: '</span> + err);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        checkForMessages(sbService, queueName);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        logger.log(<span class="string">'Error during check for messages.'</span>);</span><br><span class="line">        logger.error(error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">5000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Azure-Logic-Apps"><a href="#Azure-Logic-Apps" class="headerlink" title="Azure Logic Apps"></a>Azure Logic Apps</h3><p><img src="/images/scraper/logicapp.PNG"><br>Now that we can initiate a scrape session with a Service Bus queue message. We should queue some scrape commands.<br>I chose to use Logic Apps for that because its on pay per use base and secondly its just a basic workflow which probably doesn’t change a lot.<br>Another benefit of Azure Logic Apps is the ability to analyse your ‘runs’ and exactly see the data flow through your Logic App.<br>The steps are pretty basic and straight forward.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2019/02/15/Building-a-Web-Scraper-in-Azure/" data-id="cjx1slxr0001z60cc6hz5s2fh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions/">Functions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logic-Apps/">Logic Apps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/">TypeScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Wordpress/">Wordpress</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Using-Wordpress-in-Serverless-Azure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/25/Using-Wordpress-in-Serverless-Azure/" class="article-date">
  <time datetime="2019-01-25T08:12:18.000Z" itemprop="datePublished">2019-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/25/Using-Wordpress-in-Serverless-Azure/">Using Wordpress / Woocommerce in Serverless Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Sometimes Wordpress isn’t that bad. When for instance you’re building a SEO optimized landing page for a custom made tool and you don’t want to develop everything your self. Secondly, Wordpress has thousands of plugins that can be very useful. In my case we are using Woocomerce with a subscription payment module, so that we can manage payed subscriptions for our tool and secondly we want to manage the user accounts inside Wordpress. This saves me lots of development hours and next to that I don’t have to build any maintenance tooling since that is already inplace in Wordpress. So first line support can be done by not-so-much technical people, in other words they won’t call for every problem :)</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><img src="/images/wordpress azure.png"><br>So in essence its very easy. We just have a user with a single set of credentials which he can use in both the SEO optimized page, lets say <code>example.com</code> and in the custom made tool lets say <code>app.example.com</code>. Using the <a href="https://wordpress.org/plugins/jwt-authentication-for-wp-rest-api/" target="_blank" rel="noopener">JWT Authentication for WP REST API</a> plugin of Wordpress we can login any user and get a JWT bearer token as response. The JWT Authentication plugin requires a JWT Auth Secret key which we can define and share with the <code>Azure Functions</code> backend. The functions backend then checks the validity of incoming Bearer token with the shared JWT Auth Secret key, making an additional call to Wordpress unnecessary. Its blazing fast.</p>
<p>But we are not there yet. We need some communication between the Functions backend and Wordpress on an application to application level. In my case I want to retrieve the available subscriptions and the active subscription for a user from Wordpress / Woocommerce. Subscriptions are the trial, starter, business and pro packs that users can buy and those “packs” enable the user some privileges inside my Angular tool. Since its app to app communication I can’t use a Bearer token, because thats user context bounded, and secondly the <a href="https://docs.woocommerce.com/document/woocommerce-rest-api/" target="_blank" rel="noopener">Woocommerce API</a> requires an OAuth 1.0 authentication. It comes down to this. The Functions backend requires a <code>Consumer key</code> and a <code>Consumer secret</code> which need to be passed into a query string. Postman has excellent OAuth 1.0 support to test it out.</p>
<p><strong>Keep in mind to not add the empty parameters to the signature. Woocommerce doesn’t support it.</strong></p>
<p><img src="/images/postman oauth1.png"></p>
<p>So how does this look like in code. There are 2 parts that I want to share with you. Verifying a JWT Bearer token based on a JWT Auth Secret key and the OAuth 1 implementation with Woocommerce.</p>
<h3 id="Verifying-a-JWT-Bearer-token"><a href="#Verifying-a-JWT-Bearer-token" class="headerlink" title="Verifying a JWT Bearer token"></a>Verifying a JWT Bearer token</h3><ul>
<li><p>Perform a Http REST call from Angular.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> authenticate(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> authResponse = <span class="keyword">await</span> <span class="keyword">this</span>.http.post(environment.wordpressBackend + <span class="keyword">this</span>.jwtEndpoint, &#123; username, password &#125;).toPromise();</span><br><span class="line">    localStorage.setItem(<span class="string">'token'</span>, (authResponse <span class="keyword">as</span> AuthResponse).token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> getSubscription() &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.http.get(environment.tradersmateBackend + <span class="string">'api/subscriptions'</span>).toPromise();</span><br><span class="line">    localStorage.setItem(<span class="string">'subscription'</span>, res <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Wordpress anwers with a JWT Bearer token and some meta information.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"token"</span>: <span class="string">"secrettokenwillbehere"</span>,</span><br><span class="line">    <span class="attr">"user_email"</span>: <span class="string">"dibran@example.com"</span>,</span><br><span class="line">    <span class="attr">"user_nicename"</span>: <span class="string">"dibranmulder"</span>,</span><br><span class="line">    <span class="attr">"user_display_name"</span>: <span class="string">"Dibran Mulder"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Perform a <code>protected</code> Azure Function call, using an Angular interceptor to add the Bearer token.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  HttpRequest,</span><br><span class="line">  HttpHandler,</span><br><span class="line">  HttpEvent,</span><br><span class="line">  HttpInterceptor</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@angular/common/http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">'rxjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> TokenInterceptor <span class="keyword">implements</span> HttpInterceptor &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> auth: AuthService</span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  intercept(request: HttpRequest&lt;<span class="built_in">any</span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="keyword">this</span>.auth.getToken();</span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      request = request.clone(&#123;</span><br><span class="line">        setHeaders: &#123;</span><br><span class="line">          Authorization: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.handle(request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>A backend Azure Function checks the incoming Http Request and validates the Bearer token. </p>
</li>
<li>Don’t forget to respond with a 401 status code when the token is invalid.</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"SomeGet"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">GetSome</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Anonymous, <span class="string">"get"</span>, Route = <span class="string">"some"</span></span>)] HttpRequestMessage req,</span></span><br><span class="line"><span class="function">    [Inject] IValidateJwt validateJwt,</span></span><br><span class="line"><span class="function">    ILogger log)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        log.LogInformation(<span class="string">"Product add called"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Throws an UnAuthorizedException exception when the Bearer token can't be validated.</span></span><br><span class="line">        <span class="keyword">int</span> userId = validateJwt.ValidateToken(req);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do some business logic here.</span></span><br><span class="line">        <span class="keyword">var</span> results = ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> req.CreateResponse(HttpStatusCode.OK, results);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (UnAuthorizedException e)</span><br><span class="line">    &#123;</span><br><span class="line">        log.LogError(e.Message, e);</span><br><span class="line">        <span class="keyword">return</span> req.CreateResponse(HttpStatusCode.Unauthorized);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        log.LogError(e.Message, e);</span><br><span class="line">        <span class="keyword">return</span> req.CreateErrorResponse(HttpStatusCode.BadRequest, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Verify the Bearer token inside your Azure Functions.</li>
<li>Inject the JWT Auth Secret Key into the constructor.</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ValidateJwt</span> : <span class="title">IValidateJwt</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> dataClaimType = <span class="string">"data"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> TokenValidationParameters tokenValidationParameters;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ValidateJwt</span>(<span class="params"><span class="keyword">string</span> secretKey</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        tokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters</span><br><span class="line">        &#123;</span><br><span class="line">            IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(Encoding.ASCII.GetBytes(secretKey)),</span><br><span class="line">            ValidateIssuerSigningKey = <span class="literal">true</span>,</span><br><span class="line">            ValidateIssuer = <span class="literal">false</span>,</span><br><span class="line">            ValidateAudience = <span class="literal">false</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">ValidateToken</span>(<span class="params">HttpRequestMessage httpRequest</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// We need bearer authentication.</span></span><br><span class="line">            <span class="keyword">if</span> (httpRequest.Headers.Authorization.Scheme != <span class="string">"Bearer"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnAuthorizedException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the token.</span></span><br><span class="line">            <span class="keyword">string</span> authToken = httpRequest.Headers.Authorization.Parameter;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(authToken))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnAuthorizedException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> tokenHandler = <span class="keyword">new</span> JwtSecurityTokenHandler();</span><br><span class="line">            <span class="comment">// Validate it.</span></span><br><span class="line">            ClaimsPrincipal principal = tokenHandler.ValidateToken(authToken, tokenValidationParameters, <span class="keyword">out</span> SecurityToken validatedToken);</span><br><span class="line">            <span class="keyword">if</span> (principal.Identity.IsAuthenticated)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Check for a data claim.</span></span><br><span class="line">                <span class="keyword">if</span> (principal.HasClaim(x =&gt; x.Type == dataClaimType))</span><br><span class="line">                &#123;</span><br><span class="line">                    Claim dataClaim = principal.Claims.FirstOrDefault(x =&gt; x.Type == dataClaimType);</span><br><span class="line">                    <span class="keyword">var</span> userObj = JsonConvert.DeserializeObject&lt;DataClaim&gt;(dataClaim.Value);</span><br><span class="line">                    <span class="comment">// With a user object.</span></span><br><span class="line">                    <span class="keyword">if</span> (userObj != <span class="literal">null</span> &amp;&amp; userObj.User != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">return</span> userObj.User.Id;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnAuthorizedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Calling-Woocommerce-with-OAuth-1-0"><a href="#Calling-Woocommerce-with-OAuth-1-0" class="headerlink" title="Calling Woocommerce with OAuth 1.0"></a>Calling Woocommerce with OAuth 1.0</h2><p>To interact with the Woocommerce API we need to implement the OAuth 1 flow. Its not used that much so you won’t find a lot of C# examples online. Here’s mine.</p>
<p>Inject a <code>HttpClient</code>, <code>ConsumerKey</code> and <code>ConsumerSecret</code> into the Constructor. Only set the OAuth properties that are actually used, remember the Postman option with including empty parameters. It was a pain in the ass to get in working but I tested this client with Wordpress 5.0.3 and Woocommerce 3.5.4.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WordpressHttpClient</span> : <span class="title">BaseHttpClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> consumerKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> consumerSecret;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Random rand;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WordpressHttpClient</span>(<span class="params"><span class="keyword">string</span> consumerKey, <span class="keyword">string</span> consumerSecret, HttpClient httpClient</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">httpClient</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        rand = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">this</span>.consumerKey = consumerKey;</span><br><span class="line">        <span class="keyword">this</span>.consumerSecret = consumerSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;Subscription&gt;&gt; GetSubscriptionsAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nonce = GetNonce();</span><br><span class="line">        <span class="keyword">var</span> timeStamp = GetTimeStamp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> queryCollection = HttpUtility.ParseQueryString(<span class="keyword">string</span>.Empty);</span><br><span class="line">        queryCollection[<span class="string">"oauth_consumer_key"</span>] = consumerKey;</span><br><span class="line">        queryCollection[<span class="string">"oauth_signature_method"</span>] = <span class="string">"HMAC-SHA1"</span>;</span><br><span class="line">        queryCollection[<span class="string">"oauth_timestamp"</span>] = timeStamp;</span><br><span class="line">        queryCollection[<span class="string">"oauth_nonce"</span>] = nonce;</span><br><span class="line">        queryCollection[<span class="string">"oauth_version"</span>] = <span class="string">"1.0"</span>;</span><br><span class="line">        <span class="keyword">string</span> baseQueryString = queryCollection.ToString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> requestParameters = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">string</span> key <span class="keyword">in</span> queryCollection)</span><br><span class="line">        &#123;</span><br><span class="line">            requestParameters.Add(<span class="string">$"<span class="subst">&#123;key&#125;</span>=<span class="subst">&#123;queryCollection[key]&#125;</span>"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We need to sign a base string.</span></span><br><span class="line">        <span class="keyword">string</span> otherBase = GetSignatureBaseString(HttpMethod.Get.ToString(), <span class="string">"https://www.example.com/wp-json/wc/v1/subscriptions"</span>, requestParameters);</span><br><span class="line">        <span class="keyword">var</span> otherSignature = GetSignature(otherBase, consumerSecret);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add that signature to the query parameters.</span></span><br><span class="line">        queryCollection[<span class="string">"oauth_signature"</span>] = otherSignature;</span><br><span class="line">        <span class="keyword">string</span> finalQueryString = queryCollection.ToString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// And actually perform the request.</span></span><br><span class="line">        <span class="keyword">var</span> finalUri = <span class="keyword">new</span> Uri(<span class="string">"https://www.example.com/wp-json/wc/v1/subscriptions?"</span> + finalQueryString, UriKind.Absolute);</span><br><span class="line">        HttpRequestMessage httpRequestMessage = <span class="keyword">new</span> HttpRequestMessage(HttpMethod.Get, finalUri);</span><br><span class="line">        <span class="keyword">var</span> response = <span class="keyword">await</span> Client.SendAsync(httpRequestMessage);</span><br><span class="line">        response.EnsureSuccessStatusCode();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.Content.ReadAsAsync&lt;Subscription[]&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetNonce</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> nonce = rand.Next(<span class="number">1000000000</span>);</span><br><span class="line">        <span class="keyword">return</span> nonce.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetTimeStamp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ts = DateTime.UtcNow - <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> Convert.ToInt64(ts.TotalSeconds).ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetSignature</span>(<span class="params"><span class="keyword">string</span> signatureBaseString, <span class="keyword">string</span> consumerSecret, <span class="keyword">string</span> tokenSecret = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> hmacsha1 = <span class="keyword">new</span> HMACSHA1();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> key = Uri.EscapeDataString(consumerSecret) + <span class="string">"&amp;"</span> + (<span class="keyword">string</span>.IsNullOrEmpty(tokenSecret)</span><br><span class="line">                        ? <span class="string">""</span></span><br><span class="line">                        : Uri.EscapeDataString(tokenSecret));</span><br><span class="line">        hmacsha1.Key = Encoding.ASCII.GetBytes(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dataBuffer = Encoding.ASCII.GetBytes(signatureBaseString);</span><br><span class="line">        <span class="keyword">var</span> hashBytes = hmacsha1.ComputeHash(dataBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Convert.ToBase64String(hashBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">GetSignatureBaseString</span>(<span class="params"><span class="keyword">string</span> method, <span class="keyword">string</span> url, List&lt;<span class="keyword">string</span>&gt; requestParameters</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> sortedList = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(requestParameters);</span><br><span class="line">        sortedList.Sort();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> requestParametersSortedString = ConcatList(sortedList, <span class="string">"&amp;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Url must be slightly reformatted because of:</span></span><br><span class="line">        url = ConstructRequestUrl(url);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> method.ToUpper() + <span class="string">"&amp;"</span> + Uri.EscapeDataString(url) + <span class="string">"&amp;"</span> +</span><br><span class="line">                Uri.EscapeDataString(requestParametersSortedString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">ConstructRequestUrl</span>(<span class="params"><span class="keyword">string</span> url</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> uri = <span class="keyword">new</span> Uri(url, UriKind.Absolute);</span><br><span class="line">        <span class="keyword">var</span> normUrl = <span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125;://&#123;1&#125;"</span>, uri.Scheme, uri.Host);</span><br><span class="line">        <span class="keyword">if</span> (!(uri.Scheme == <span class="string">"http"</span> &amp;&amp; uri.Port == <span class="number">80</span> || uri.Scheme == <span class="string">"https"</span> &amp;&amp; uri.Port == <span class="number">443</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            normUrl += <span class="string">":"</span> + uri.Port;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        normUrl += uri.AbsolutePath;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> normUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; <span class="title">ExtractQueryParameters</span>(<span class="params"><span class="keyword">string</span> queryString</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (queryString.StartsWith(<span class="string">"?"</span>))</span><br><span class="line">            queryString = queryString.Remove(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(queryString))</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> s <span class="keyword">in</span> queryString.Split(<span class="string">'&amp;'</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(s) &amp;&amp; !s.StartsWith(<span class="string">"oauth_"</span>))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (s.IndexOf(<span class="string">'='</span>) &gt; <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> temp = s.Split(<span class="string">'='</span>);</span><br><span class="line">                    result.Add(temp[<span class="number">0</span>], temp[<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    result.Add(s, <span class="keyword">string</span>.Empty);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">ConcatList</span>(<span class="params">IEnumerable&lt;<span class="keyword">string</span>&gt; source, <span class="keyword">string</span> separator</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> s <span class="keyword">in</span> source)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (sb.Length == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sb.Append(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sb.Append(separator);</span><br><span class="line">                sb.Append(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2019/01/25/Using-Wordpress-in-Serverless-Azure/" data-id="cjx1slxr1002160cc7cz51k0o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions/">Functions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Woocommerce/">Woocommerce</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Wordpress/">Wordpress</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-Functions-Http-Response-caching" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/14/Azure-Functions-Http-Response-caching/" class="article-date">
  <time datetime="2019-01-14T13:06:13.000Z" itemprop="datePublished">2019-01-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/14/Azure-Functions-Http-Response-caching/">Azure Functions Http Response caching</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>As you might know its a <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-best-practices#write-functions-to-be-stateless" target="_blank" rel="noopener">best practice to keep your Azure Functions stateless</a>. That means that also in memory caching should not be done inside your functions. Especially when you’re using a consumption plan. Your cache will be recycled when the plan goes to sleep.<br>What a lot of fokes forget is that the Http protocol as of Http 1.1 contains caching. Setting the right caching headers on a <code>HttpResponseMessage</code> is actually quite easy.</p>
<p><a href="https://docs.microsoft.com/en-us/aspnet/core/performance/caching/response?view=aspnetcore-2.2" target="_blank" rel="noopener">In ASP.net core we even had packages for us to do that</a>. Those obviously don’t work for functions since the attributes can’t be placed on top of Azure Functions with Http Triggers. So sadly we’ve to write code to se the right headers. However its so easy that you won’t be sad for long.</p>
<p>Here’s a simple Http triggered function. Notice the <code>CreateCachedResponse</code> instead of <code>CreateResponse</code> extension method.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FunctionName(<span class="meta-string">"SomeFunction"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">SomeHttpTriggeredFunctions</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Anonymous, <span class="string">"post"</span>, Route = <span class="string">"some/route"</span></span>)] HttpRequestMessage req,</span></span><br><span class="line"><span class="function">    ILogger log)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        log.LogInformation(<span class="string">"SomeFunction called"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do something</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> req.CreateCachedResponse(HttpStatusCode.OK, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        log.LogError(e.Message, e);</span><br><span class="line">        <span class="keyword">return</span> req.CreateErrorResponse(HttpStatusCode.BadRequest, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In the extension method we will simply add some headers to the response.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http.Headers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">CacheResponseExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpResponseMessage CreateCachedResponse&lt;T&gt;(<span class="keyword">this</span> HttpRequestMessage request, HttpStatusCode statusCode, T <span class="keyword">value</span>, TimeSpan? maxAge = <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        HttpResponseMessage responseMessage = request.CreateResponse&lt;T&gt;(statusCode, <span class="keyword">value</span>);</span><br><span class="line">        responseMessage.Headers.CacheControl = <span class="keyword">new</span> CacheControlHeaderValue()</span><br><span class="line">        &#123;</span><br><span class="line">            Public = <span class="literal">true</span>,</span><br><span class="line">            MaxAge = maxAge ?? defaultTimeSpan</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> responseMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>And voila we’ve got client side caching working.</p>
<p><img src="/images/cache-functions.png"></p>
<p><a href="https://docs.microsoft.com/en-us/aspnet/core/performance/caching/response?view=aspnetcore-2.2" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/aspnet/core/performance/caching/response?view=aspnetcore-2.2</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2019/01/14/Azure-Functions-Http-Response-caching/" data-id="cjx1slxpx000560ccu36rf3an" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cache/">Cache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functions/">Functions</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-API-Management-ARM-Cheatsheet" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/19/Azure-API-Management-ARM-Cheatsheet/" class="article-date">
  <time datetime="2018-12-19T09:09:25.000Z" itemprop="datePublished">2018-12-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/19/Azure-API-Management-ARM-Cheatsheet/">Azure API Management ARM Cheat sheet</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Deploying an API Management instance via ARM is complicated. I’ve created a cheat sheet to help you out.<br>Alot is copied from a complete template originating from <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/201-api-management-create-all-resources" target="_blank" rel="noopener">Github</a>.</p>
<h2 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h2><p>ARM might be the way to deploy a pre-setup instance. For adding API’s to an existing API Management instance I prefer to use the <a href="https://github.com/stephaneey/azure-apim-extension" target="_blank" rel="noopener">API Management extensions</a> from the Azure DevOps Marketplace. </p>
<h3 id="Instance"><a href="#Instance" class="headerlink" title="Instance"></a>Instance</h3><p>Parameterize every option, in your ARM script. Resources sucha as policies, products, api’s and such go into the sub resources array.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"[variables('apiManagementServiceName')]"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Microsoft.ApiManagement/service"</span>,</span><br><span class="line">    <span class="attr">"location"</span>: <span class="string">"[parameters('location')]"</span>,</span><br><span class="line">    <span class="attr">"tags"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"sku"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"[parameters('sku')]"</span>,</span><br><span class="line">        <span class="attr">"capacity"</span>: <span class="string">"[parameters('skuCount')]"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"publisherEmail"</span>: <span class="string">"[parameters('publisherEmail')]"</span>,</span><br><span class="line">        <span class="attr">"publisherName"</span>: <span class="string">"[parameters('publisherName')]"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"resources"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Tenant-policy"><a href="#Tenant-policy" class="headerlink" title="Tenant policy"></a>Tenant policy</h3><p>To create a tenant wide policy.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"policies"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"policy"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"policyContent"</span>: <span class="string">"[parameters('tenantPolicy')]"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="API’s"><a href="#API’s" class="headerlink" title="API’s"></a>API’s</h3><p>Adding API’s can be done via Open API definitions. If your Open API definition doesn’t contain a <code>host</code> property, like: <code>&quot;host&quot;:&quot;somewebsite.azurewebsites.net&quot;</code>. Then you should add the <code>service url</code> property inside your ARM.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"apis"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"PetStoreSwaggerImportExample"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"contentFormat"</span>: <span class="string">"SwaggerLinkJson"</span>,</span><br><span class="line">        <span class="attr">"contentValue"</span>: <span class="string">"http://petstore.swagger.io/v2/swagger.json"</span>,</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"examplepetstore"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>You can also add operations manually, without using Open API definitions.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"apis"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleApi"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"displayName"</span>: <span class="string">"Example API Name"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"Description for example API"</span>,</span><br><span class="line">        <span class="attr">"serviceUrl"</span>: <span class="string">"https://example.net"</span>,</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"exampleapipath"</span>,</span><br><span class="line">        <span class="attr">"protocols"</span>: [</span><br><span class="line">            <span class="string">"HTTPS"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"resources"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"operations"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"exampleOperationsDELETE"</span>,</span><br><span class="line">            <span class="attr">"dependsOn"</span>: [</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/apis/exampleApi')]"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"displayName"</span>: <span class="string">"DELETE resource"</span>,</span><br><span class="line">                <span class="attr">"method"</span>: <span class="string">"DELETE"</span>,</span><br><span class="line">                <span class="attr">"urlTemplate"</span>: <span class="string">"/resource"</span>,</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"A demonstration of a DELETE call"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"operations"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"exampleOperationsGET"</span>,</span><br><span class="line">            <span class="attr">"dependsOn"</span>: [</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/apis/exampleApi')]"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"displayName"</span>: <span class="string">"GET resource"</span>,</span><br><span class="line">                <span class="attr">"method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">                <span class="attr">"urlTemplate"</span>: <span class="string">"/resource"</span>,</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"A demonstration of a GET call"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"resources"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"policies"</span>,</span><br><span class="line">                    <span class="attr">"name"</span>: <span class="string">"policy"</span>,</span><br><span class="line">                    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">                        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span>,</span><br><span class="line">                        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/apis/exampleApi')]"</span>,</span><br><span class="line">                        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/apis/exampleApi/operations/exampleOperationsGET')]"</span></span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                        <span class="attr">"policyContent"</span>: <span class="string">"[parameters('operationPolicy')]"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are also other ways, such as WSDL, and inserting Open API definitions as a value in your ARM.<br>See the <a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.apimanagement/2017-03-01/service/apis" target="_blank" rel="noopener">documentation</a> and check for <code>contentFormat</code> and <code>contentValue</code>.</p>
<h3 id="Product"><a href="#Product" class="headerlink" title="Product"></a>Product</h3><p>To create a product and add API’s directly to the product.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"products"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleProduct"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"displayName"</span>: <span class="string">"Example Product Name"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"Description for example product"</span>,</span><br><span class="line">        <span class="attr">"terms"</span>: <span class="string">"Terms for example product"</span>,</span><br><span class="line">        <span class="attr">"subscriptionRequired"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"approvalRequired"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"subscriptionsLimit"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"state"</span>: <span class="string">"published"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"resources"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"apis"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"exampleApi"</span>,</span><br><span class="line">            <span class="attr">"dependsOn"</span>: [</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span>,</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/apis/exampleApi')]"</span>,</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/products/exampleProduct')]"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"policies"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"policy"</span>,</span><br><span class="line">            <span class="attr">"dependsOn"</span>: [</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span>,</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/products/exampleProduct')]"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"policyContent"</span>: <span class="string">"[parameters('productPolicy')]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="User"><a href="#User" class="headerlink" title="User"></a>User</h3><p>To create a user. But think of using Azure AAD integration.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"users"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleUser1"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"firstName"</span>: <span class="string">"ExampleFirstName1"</span>,</span><br><span class="line">        <span class="attr">"lastName"</span>: <span class="string">"ExampleLastName1"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"ExampleFirst1@example.com"</span>,</span><br><span class="line">        <span class="attr">"state"</span>: <span class="string">"active"</span>,</span><br><span class="line">        <span class="attr">"note"</span>: <span class="string">"note for example user 1"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h3><p>To create a group of users.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"groups"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleGroup"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"displayName"</span>: <span class="string">"Example Group Name"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"Example group description"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"resources"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"users"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"exampleUser3"</span>,</span><br><span class="line">            <span class="attr">"dependsOn"</span>: [</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span>,</span><br><span class="line">                <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/groups/exampleGroup')]"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h3><p>To create a subscription for a user.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"subscriptions"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"examplesubscription1"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span>,</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/products/exampleProduct')]"</span>,</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'), '/users/exampleUser1')]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"productId"</span>: <span class="string">"/subscriptions/&#123;subscriptionId&#125;/resourceGroups/&#123;resourceGroupName&#125;/providers/Microsoft.ApiManagement/service/exampleServiceName/products/exampleProduct"</span>,</span><br><span class="line">        <span class="attr">"userId"</span>: <span class="string">"/subscriptions/&#123;subscriptionId&#125;/resourceGroups/&#123;resourceGroupName&#125;/providers/Microsoft.ApiManagement/service/exampleServiceName/users/exampleUser1"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Named-values"><a href="#Named-values" class="headerlink" title="Named values"></a>Named values</h3><p>Add named values, often used in policies as variables.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"properties"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleproperties"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"displayName"</span>: <span class="string">"propertyExampleName"</span>,</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"propertyExampleValue"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: [</span><br><span class="line">            <span class="string">"exampleTag"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>To create a certificate.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"certificates"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleCertificate"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"data"</span>: <span class="string">"[parameters('mutualAuthenticationCertificate')]"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"[parameters('certificatePassword')]"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="OpenId-Connect"><a href="#OpenId-Connect" class="headerlink" title="OpenId Connect"></a>OpenId Connect</h4><p>For OpenId integration.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"openidConnectProviders"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleOpenIdConnectProvider"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"displayName"</span>: <span class="string">"exampleOpenIdConnectProviderName"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"Description for example OpenId Connect provider"</span>,</span><br><span class="line">        <span class="attr">"metadataEndpoint"</span>: <span class="string">"https://example-openIdConnect-url.net"</span>,</span><br><span class="line">        <span class="attr">"clientId"</span>: <span class="string">"exampleClientId"</span>,</span><br><span class="line">        <span class="attr">"clientSecret"</span>: <span class="string">"[parameters('openIdConnectClientSecret')]"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Identity-providers"><a href="#Identity-providers" class="headerlink" title="Identity providers"></a>Identity providers</h4><p>You can add multiple identity providers. The following providers are available.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"facebook"</span>,</span><br><span class="line"><span class="string">"google"</span>,</span><br><span class="line"><span class="string">"microsoft"</span>,</span><br><span class="line"><span class="string">"twitter"</span>,</span><br><span class="line"><span class="string">"aad"</span>,</span><br><span class="line"><span class="string">"aadB2C"</span>]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"identityProviders"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"google"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"clientId"</span>: <span class="string">"googleClientId"</span>,</span><br><span class="line">        <span class="attr">"clientSecret"</span>: <span class="string">"[parameters('googleClientSecret')]"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Logger"><a href="#Logger" class="headerlink" title="Logger"></a>Logger</h3><p>You can use either <code>EventHub</code> or <code>Application Insights</code> as a Logging framework.<br>The difference is in the credentials.</p>
<h4 id="Eventhub"><a href="#Eventhub" class="headerlink" title="Eventhub"></a>Eventhub</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"loggers"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleLogger"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"loggerType"</span>: <span class="string">"azureEventHub"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"Description for example logger"</span>,</span><br><span class="line">        <span class="attr">"credentials"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"exampleEventHubName"</span>,</span><br><span class="line">            <span class="attr">"connectionString"</span>: <span class="string">"[parameters('eventHubNamespaceConnectionString')]"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Application-Insights"><a href="#Application-Insights" class="headerlink" title="Application Insights"></a>Application Insights</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"2017-03-01"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"loggers"</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"exampleLogger"</span>,</span><br><span class="line">    <span class="attr">"dependsOn"</span>: [</span><br><span class="line">        <span class="string">"[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"loggerType"</span>: <span class="string">"applicationInsights"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"Description for example logger"</span>,</span><br><span class="line">        <span class="attr">"credentials"</span>: <span class="string">"3e2e9837-b17b-44b3-a652-ed296080c57d"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://docs.microsoft.com/en-us/azure/templates/microsoft.apimanagement/2018-01-01/service" target="_blank" rel="noopener">Microsoft ARM Docs</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2018/12/19/Azure-API-Management-ARM-Cheatsheet/" data-id="cjx1slxqw001t60cc6sb27107" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/API-Management/">API Management</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Azure-Api-Management-overview" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/13/Azure-Api-Management-overview/" class="article-date">
  <time datetime="2018-11-13T15:43:45.000Z" itemprop="datePublished">2018-11-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/13/Azure-Api-Management-overview/">Azure API  Management overview</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Azure API Management is a jungle of configurations, options and possibilities. The documentation is not always that clear and sometimes its hard to see what your options are and which suit your solution best. In this blogpost I’m trying to shine some light into that darkness.</p>
<h2 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h2><p>Lest started with some very basics. API Management(from now on APIM, cauz im lazy) is a service sitting in the middle of a consuming client application and a backend service. Its there for reasons, such as: enforcing policies, caching, routing, security and so on. Its often used as a central hub within a company to manage outgoing and incomming traffic. Its main goal is to retrain control over your API’s.</p>
<p><img src="/images/apim/apim basic.png"></p>
<ul>
<li>The consuming client applications are called: Client or front-end application.</li>
<li>The incomming traffic from a client application is call inbound traffic.</li>
<li>Your API which you are disclosing via APIM is called the backend service or api.</li>
<li>The response from the backend service is called outbound traffic.</li>
</ul>
<p><img src="/images/apim/apim basic flow.png"></p>
<h3 id="Products-and-groups"><a href="#Products-and-groups" class="headerlink" title="Products and groups"></a>Products and groups</h3><p>Next up APIM got some features and data structures which you need to be familiar with. It all starts with products and groups. A product essentially is a set of API’s. For a client application to be effective it might have to consult several backend api’s to get all data. Especially when you are using a microservice based architecture. A product then might be a combination of multiple backend api’s. Its important to keep in mind that a set of backend API’s should look like one product from a client application perspective. Once you’ve defined a set of API’s for a product you’ll have to grant groups of users to a product. APIM also contains a build in group called ‘Guests’ which once allowed access to a product opens up your API’s in your product for everyone. </p>
<h3 id="Subscriptions"><a href="#Subscriptions" class="headerlink" title="Subscriptions"></a>Subscriptions</h3><p>You can also choose to enable subscriptions for a product. Once enabled users have to request a subscription and they obtain a set of keys. Those keys should be added to every call to APIM so that APIM can validate if your subscription is still valid.</p>
<h3 id="Policies"><a href="#Policies" class="headerlink" title="Policies"></a>Policies</h3><p>Lastly a product can also contain policies. Later you’ll see that you can also define policies on API or even on operation level. Policies applied on product level apply on every API inside the product. Its a hierachial system for defining policies.</p>
<h2 id="Add-API’s"><a href="#Add-API’s" class="headerlink" title="Add API’s"></a>Add API’s</h2><p><img src="/images/apim/addapi.png"><br>You can add API’s in various ways. With a blank API’s you’ll have to define every thing youself. Its doesn’t bootstrap any operations or whatsoever. Other options do bootstrap your API’s inside APIM. OpenAPI spefications for instance delivery detailed operations and improve efficiency and usability. OpenAPI definitions were previously called Swagger definitions. </p>
<p>Its also possibile to integrate with a Function App in Api Management. As discussed in <a href="2018/10/19/Building-Serverless-APIs-in-Azure/">this post</a> an API Gateway is recommended when you’re creating a Serverless API or when you’re using a Microservice based architecture. Be aware that OpenAPI definitons inside Azure Functions V2 are still in preview and therefore the bootstrapped operations lack some detail.</p>
<p>In the next blogpost I’ll address the CI/CD posibilities in combination with APIM. In my opinion its indispensable for a DevOps team, let alone a whole company using the same APIM instance.</p>
<h2 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h2><p><img src="/images/apim/apim.png"></p>
<h3 id="Client-Authentication"><a href="#Client-Authentication" class="headerlink" title="Client Authentication"></a>Client Authentication</h3><p>OpenId<br>OAuth<br>Subscription Keys</p>
<h3 id="Backend-service"><a href="#Backend-service" class="headerlink" title="Backend service"></a>Backend service</h3><p>Function keys<br>Basic Auth<br>Client certificates</p>
<p><img src="/images/apim/functions keys.png"></p>
<h2 id="Policies-1"><a href="#Policies-1" class="headerlink" title="Policies"></a>Policies</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">inbound</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">inbound</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">backend</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">backend</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">outbound</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">outbound</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">on-error</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">base</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">on-error</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h3><ul>
<li>Restriction</li>
<li>Advanced</li>
<li>Authentication</li>
<li>Caching</li>
<li>Cross domain policies (CORS)</li>
<li>Transformation </li>
</ul>
<p><a href="https://docs.microsoft.com/en-us/azure/api-management/api-management-policies" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/api-management/api-management-policies</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2018/11/13/Azure-Api-Management-overview/" data-id="cjx1slxpo000060cc405c7qv0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/API-Management/">API Management</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Secrets-in-Azure-DevOps-the-bad-parts" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/25/Secrets-in-Azure-DevOps-the-bad-parts/" class="article-date">
  <time datetime="2018-10-25T10:30:57.000Z" itemprop="datePublished">2018-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/25/Secrets-in-Azure-DevOps-the-bad-parts/">Secrets in Azure DevOps the bad parts</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Storing secrets inside your build and release pipeline variables is a bad practise and Microsoft advises not to use it, but use KeyVault instead. However fact is, is that its also very convenient and easy to use, so people are going to use it alot. But what are the risks of using this? Are your secrets save?</p>
<h2 id="Decrypting-secrets"><a href="#Decrypting-secrets" class="headerlink" title="Decrypting secrets"></a>Decrypting secrets</h2><p>May 17th of 2018 FoxIt published <a href="https://www.fox-it.com/en/insights/blogs/blog/introducing-team-foundation-server-decryption-tool/" target="_blank" rel="noopener">a tool</a> to decrypt secrets from the TFS/VSTS and now AzureDevops variable stores. This tool on itself is a huge risk from a compliance and security perspective.</p>
<p>Imagine you store connection strings or passwords inside the variables store and they provide access to your production databases. Malicious developers are now able to retrieve those secrets and do their harm. Without any trace. Since you are not able to get a trace log from Azure DevOps. A better way the prevent variables to be decrypted is the read them from KeyVault. </p>
<p><img src="/images/secrets.png"></p>
<h2 id="Secrets-in-ARM-scripts"><a href="#Secrets-in-ARM-scripts" class="headerlink" title="Secrets in ARM scripts"></a>Secrets in ARM scripts</h2><p>Another risk with using secrets inside ARM scripts is the risk of exposing variables without knowing it. ARM parameters are often strings, for example: usernames, password, connection strings, etc. Those strings might come from trusted sources maybe even a KeyVault. One mistake thats often made is that those parameters are of type string. See the example below, these are the parameters for a basic WebApp ARM Script. In this WebApp we want to access a database and we want to have the connection string to that database as a parameter.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"parameters"</span>: &#123;</span><br><span class="line">        <span class="attr">"webAppName"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"Base name of the resource such as web app name and app service plan "</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"minLength"</span>: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"sku"</span>:&#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"defaultValue"</span> : <span class="string">"S1"</span>,</span><br><span class="line">            <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"The SKU of App Service Plan, by defaut is standard  S1"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"location"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"defaultValue"</span>: <span class="string">"[resourceGroup().location]"</span>,</span><br><span class="line">            <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"Location for all resources."</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"databaseConnectionString"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"defaultValue"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"The connection string to the database."</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What a lot of people don’t know is that you can look into the deployments of a Resource Group. Simply go to <code>Resource groups</code> &gt; <code>Deployments</code> and select one. If a parameter is not marked as type: <code>securestring</code> then it will be shown in plain text. The bad part of this experience is that you require very few rights to look into the deployments of a resource group. Read rights are enough. You are for instance prohibited to look into the app settings or connection strings of a WebApp but you are often allowed to look into this deployments.</p>
<p>The correct parameter type should be the following:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"parameters"</span>: &#123;</span><br><span class="line">        <span class="attr">"databaseConnectionString"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"securestring"</span>,</span><br><span class="line">            <span class="attr">"defaultValue"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"The connection string to the database."</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dibranmulder.github.io/2018/10/25/Secrets-in-Azure-DevOps-the-bad-parts/" data-id="cjx1slxq1000c60ccxkwrvvrn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure-DevOps/">Azure DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AD/">AD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-Gateway/">API Gateway</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-Management/">API Management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API-management/">API management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Availability-Zone/">Availability Zone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-DevOps/">Azure DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-Functions/">Azure Functions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/">Azure, PaaS, Serverless, Teams, Agile, Versioning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Caesar/">Caesar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CosmosDb/">CosmosDb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dependency-Injection/">Dependency Injection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EF-Core/">EF Core</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Entity-Framework-Core/">Entity Framework Core</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functions/">Functions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functions-V2/">Functions V2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logic-Apps/">Logic Apps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MSI/">MSI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Migrations/">Migrations</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Resilient/">Resilient</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-Server/">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Security/">Security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Service-Health/">Service Health</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Table-Storage/">Table Storage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSTS/">VSTS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Woocommerce/">Woocommerce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wordpress/">Wordpress</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AD/" style="font-size: 10px;">AD</a> <a href="/tags/API-Gateway/" style="font-size: 10px;">API Gateway</a> <a href="/tags/API-Management/" style="font-size: 12.5px;">API Management</a> <a href="/tags/API-management/" style="font-size: 10px;">API management</a> <a href="/tags/Availability-Zone/" style="font-size: 10px;">Availability Zone</a> <a href="/tags/Azure/" style="font-size: 20px;">Azure</a> <a href="/tags/Azure-DevOps/" style="font-size: 10px;">Azure DevOps</a> <a href="/tags/Azure-Functions/" style="font-size: 10px;">Azure Functions</a> <a href="/tags/Azure-PaaS-Serverless-Teams-Agile-Versioning/" style="font-size: 10px;">Azure, PaaS, Serverless, Teams, Agile, Versioning</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Caesar/" style="font-size: 10px;">Caesar</a> <a href="/tags/CosmosDb/" style="font-size: 15px;">CosmosDb</a> <a href="/tags/Dependency-Injection/" style="font-size: 10px;">Dependency Injection</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/EF-Core/" style="font-size: 10px;">EF Core</a> <a href="/tags/Entity-Framework-Core/" style="font-size: 10px;">Entity Framework Core</a> <a href="/tags/Functions/" style="font-size: 17.5px;">Functions</a> <a href="/tags/Functions-V2/" style="font-size: 10px;">Functions V2</a> <a href="/tags/Logic-Apps/" style="font-size: 12.5px;">Logic Apps</a> <a href="/tags/MSI/" style="font-size: 10px;">MSI</a> <a href="/tags/Migrations/" style="font-size: 10px;">Migrations</a> <a href="/tags/Resilient/" style="font-size: 10px;">Resilient</a> <a href="/tags/SQL-Server/" style="font-size: 10px;">SQL Server</a> <a href="/tags/Security/" style="font-size: 10px;">Security</a> <a href="/tags/Service-Health/" style="font-size: 10px;">Service Health</a> <a href="/tags/Table-Storage/" style="font-size: 10px;">Table Storage</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/VSTS/" style="font-size: 10px;">VSTS</a> <a href="/tags/Woocommerce/" style="font-size: 10px;">Woocommerce</a> <a href="/tags/Wordpress/" style="font-size: 12.5px;">Wordpress</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">juni 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">mei 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">april 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">maart 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">februari 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">januari 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">december 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">november 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">oktober 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">augustus 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">juli 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">juni 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/18/Learn-CosmosDb-in-20-pictures/">Learn CosmosDb in 20 pictures</a>
          </li>
        
          <li>
            <a href="/2019/05/20/Testing-time-triggered-Azure-Functions/">Locally testing Azure Functions</a>
          </li>
        
          <li>
            <a href="/2019/04/16/Versioning-with-Azure-PaaS/">Versioning with Azure PaaS and Serverless</a>
          </li>
        
          <li>
            <a href="/2019/03/22/Migrating-Azure-Table-Storage-to-SQL-with-Azure-Logic-Apps/">Migrating Azure Table Storage to SQL with Azure Logic Apps</a>
          </li>
        
          <li>
            <a href="/2019/02/15/Building-a-Web-Scraper-in-Azure/">Building a Web Scraper in Azure</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Dibran Mulder<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>